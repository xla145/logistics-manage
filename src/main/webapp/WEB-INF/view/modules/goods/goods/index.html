<#include "../../_layout/_layout.html"><#t>
<@header/>
<div class="admin-main">
	<!-- 按钮组 -->
	<blockquote class="layui-elem-quote">
		<a href="javascript:void(0)" class="layui-btn layui-btn-small" id="add"><i class="layui-icon">&#xe654;</i> 发布商品</a>
		<a href="#" class="layui-btn layui-btn-small layui-btn-normal" id="edit"><i class="layui-icon">&#xe642;</i> 编辑</a>
		<a href="#" class="layui-btn layui-btn-small layui-btn-danger" id="delete"><i class="layui-icon">&#xe640;</i> 删除</a>
	</blockquote>
	<!-- 筛选组 -->
	<blockquote class="layui-elem-quote filter-bar">
		<form class="layui-form" action="/table.html" id="filterForm">
		     <div class="layui-inline">
		      <label class="layui-form-label">发布时间：</label>
		      <div class="layui-input-inline">
		        <input type="text" name="startTime" id="start-time" placeholder="开始时间" autocomplete="off" class="layui-input" onclick="layui.laydate({elem: this})">
		      </div>
		      --
		      <div class="layui-input-inline">
		        <input type="text" name="endTime" id="end-time" placeholder="结束时间" autocomplete="off" class="layui-input" onclick="layui.laydate({elem: this})">
		      </div>
		    </div>
			<div class="layui-inline">
				<label class="layui-form-label">商品编号：</label>
				<div class="layui-input-inline">
					<input type="text" name="pid" class="layui-input">
				</div>
			</div>
		    <div class="layui-inline">
		      <label class="layui-form-label">商品标题：</label>
		      <div class="layui-input-inline">
		        <input type="text" name="title" class="layui-input">
		      </div>
		    </div>
		    <div class="layui-inline">
		      <label class="layui-form-label">商品状态：</label>
		      <div class="layui-input-inline">
		        <select name="status">
				  <option value=" ">全部</option>
				  <option value="0">初始状态</option>
				  <option value="10">上架</option>
				  <option value="14">售完下架</option>
				  <option value="15">管理员下架</option>
				</select>
		      </div>
		    </div>
			<a href="javascript:void(0)" class="layui-btn layui-btn-small" id="search"><i class="layui-icon">&#xe615;</i>搜索</a>
			<a href="javascript:void(0)" class="layui-btn layui-btn-small" id="reset"><i class="layui-icon">&#x1002;</i>重置</a>
		</form>
	</blockquote>
	<!-- 表格区域 -->
	<div class="layui-form" id="twrap">
	  <table class="layui-table lay-even clear-padding">
	    <thead>
	      <tr>
	        <th class="ckb"><input type="checkbox" name="" lay-skin="primary" lay-filter="allChoose"></th>
	        <th>序号</th>
		    <th>商品编号</th>
	        <th>商品标题</th>
	        <th>商品名称</th>
	        <!--<th>所属商品分类</th>-->
	        <th>价格</th>
	        <th>销量</th>
		  	<th>发布日期</th>
		    <!--<th>规格名称</th>-->
		    <th>包装单位</th>
		    <th>商品供应商</th>
		    <th>进货价</th>
		    <th>库存数</th>
		    <th>剩余库存数</th>
		    <th>权重</th>
		    <th fixed="right">商品状态</th>
	        <th fixed="right">操作</th>
	      </tr> 
	    </thead>
	    <tbody></tbody>
	  </table>
	  <!-- 分页容器 -->
	  <div class="layui-show"><div id="page"></div></div>
	</div>
</div>
<@footer>
<script type="text/javascript" src="${assets}js/datagrid.js"></script>
<script>
//入口
layui.use(['datagrid','laydate','layedit','upload','common'], function(){
  var $ = layui.jquery;
  var datagrid = layui.datagrid(),
      common = layui.common,
	  form = layui.form();
  //自定义验证
  form.verify({
	price: function(value){
		if(value == "") {
			return '请填写优惠券面额！';
		}
		if(/^[0-9]+(.[0-9]{2})?$/.test(value)){
			return '面额请保留两位小数！';
		}
	}
  });
  //表格数据加载插件，可选参数：
  datagrid.init({
	  url: 'list',
	  pageSize: 15,
	  pageEm: $('#page'),
	  tempEm: $('#twrap'),
	  filterForm: $('#filterForm')
  });
  
  //搜索， 依赖datagrid
  $('#search').bind('click', function(){
	  datagrid.search();	  
  })

//搜索， 依赖datagrid
  $('#reset').bind('click', function(){
      $('#filterForm')[0].reset();
      datagrid.search();
  })
  //添加、编辑插件可选配置：
  $('#add').bind('click', function(){
      layer_show("editView","添加商品信息")
  })
  $('#edit').bind('click', function(){
	  var ids = datagrid.getCheckedVal();
      if (ids.length != 1) {
          layer.msg('请选择一条数据编辑!');
          return;
      }
	  editFn(ids[0]);
  })
  
  //删除
  $('#delete').bind('click', function(){
	  var ids = datagrid.getCheckedVal();
	  if (ids.length < 1) {
		  layer.msg('请选择至少一条数据删除!');
		  return;
	  }
	  delFn(ids);
  });
  
//操作
  $('#twrap').on('click', '.operate', function(){
	  var cmd = $(this).attr('data-fn');
	  var id = $(this).siblings('.index-id').val();
      var status = $(this).siblings('.index-status').val();
	  if (cmd == 'edit') {
		  editFn(id);
	  }
	  if (cmd == 'del') {
		  delFn(id);
	  }
      if (cmd == 'stop') {
          changeStatus(id,status,"您确定要下架这些商品吗？");
      }
      if (cmd == 'start') {
          changeStatus(id,status,"您确定要上架这些商品吗？");
      }
  })
  //上下架
  var changeStatus = function (id,status,titile) {
      console.log(common.arrayTokeyval({id:id,status:status}))
      layer.confirm(titile, {icon: 3, title:'提示'}, function() {
          $.ajax({
              type: "POST",
              url: "upOrDownProduct",
              data: {id:id,status:status},
              success: function (json) {
                  if (json.code == -1) {
                      layer.msg(json.msg);
                  } else {
                      layer.msg("成功上下架！", {time: 500});
                      datagrid.search();
                  }
              }
          });
      });
  }
  //打开编辑框
    var editFn = function(id){
		if(!id){
			layer.msg('请选择一条数据编辑!');
			return;
		}
		layer_show('editView?id='+id,"修改商品信息")
  }
    var layer_show = function (url,title) {
        var index = layer.open({
            type: 2,
            title: title,
            shadeClose: true,
            shade: false,
            area: ['1000px', '600px'],
            content: url
        });
        layer.full(index);
    }
//删除数据
  var delFn = function(id){
	  if(!id){
		  layer.msg('请选择一条数据删除!');
		  return;
	  }
	  layer.confirm('您确定要删除这些商品吗？', {icon: 3, title:'提示'}, function(){
		  $.ajax({ 
			type: "POST", 
			url: "del", 
			data: common.arrayTokeyval({ids:id}),
			success: function(json) { 
				if (json.code == -1){
					layer.msg(json.msg);
				} else{
					layer.msg("删除成功！",{time:500});
					datagrid.search();
				}	
			} 
		 });
	  });  
  }
    //添加供应商
	$('#add-supplier').on('click', function(){
		layer.open({
			type: 2,
			title: '选择供应商信息',
			shadeClose: true,
			shade: false,
			maxmin: true, //开启最大化最小化按钮
			area: ['893px', '600px'],
			content: 'supplierIndex'
		});
	})
    var _tools = {
        searchData: function () {
            datagrid.search();
        },
		setSupplier: function (supplierId,supplierName) {
            $("#supplier-id").val(supplierId);
            $("#supplier-name").val(supplierName);
        }
    }
    window.tools = _tools
});
</script>
</@footer>        