<#include "../../_layout/_layout2.0.html"><#t>
<@header/>
<div id="form-save" style="margin: 15px;">
	<form class="layui-form layui-form-pane">
		<div class="layui-form-item">
			<label class="layui-form-label"><span>*</span>商品名称：</label>
			<input type="hidden" value="${data.pid!''}" name="pid" id="pid">
			<div class="layui-input-inline" style="width: 800px;">
				<input type="text" name="name" placeholder="请输入商品名称" autocomplete="off" class="layui-input" lay-verify="required" value="${data.name!''}">
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label"><span>*</span>商品类型：</label>
			<input name="catId" id="catId" type="hidden" value="${data.catId!''}">
			<div class="layui-input-inline">
				<select name="OneType" id="one-product-type" lay-filter="oneProductType">
					<option value="">全部</option>
					<@module name="option" class="com.logistics.label.impl.GetProductCategoryNode" checked="${data.parentCatId!''}"/>
				</select>
			</div>
			<div class="layui-input-inline">
				<select name="TwoType" id="two-product-type" lay-filter="twoProductType" >
					<option value="">全部</option>
				</select>
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label"><span>*</span>价格：</label>
			<div class="layui-input-inline">
				<#if data.price??>
				<input type="text" name="price" placeholder="请输入商品价格" autocomplete="off" class="layui-input" lay-verify="required" value="${data.price?string('#.##')}">
				<#else>
				<input type="text" name="price" placeholder="请输入商品价格" autocomplete="off" class="layui-input" lay-verify="required">
			</#if>
		</div>
			<label class="layui-form-label">参考价格：</label>
			<div class="layui-input-inline">
				<#if data.referencePrice??>
					<input type="text" name="referencePrice" placeholder="请输入参考价格" autocomplete="off" class="layui-input" value="${data.referencePrice?string('#.##')}">
					<#else>
					<input type="text" name="referencePrice" placeholder="请输入参考价格" autocomplete="off" class="layui-input" >
				</#if>
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">包装单位：</label>
			<div class="layui-input-inline">
				<input type="text" name="unit" placeholder="请输入包装单位" autocomplete="off" class="layui-input" value="${data.unit!''}">
			</div>
			<label class="layui-form-label"><span>*</span>供应商：</label>
			<div class="layui-input-inline">
				<select name="supplierId" lay-verify="required" lay-search>
					<option value="">请选择</option>
					<@module name="option" class="com.logistics.label.impl.GetSupplierNode" checked="${data.supplierId!''}"/>
				</select>
			</div>
		</div>
		<div class="layui-form-item">
			<fieldset class="layui-elem-field layui-field-title">
				<legend><span style="color: red;">*</span>上传封面图片：</legend>
			</fieldset>
			<div class="layui-input-inline">
				<div class="layui-upload-drag" id="img-url">
					<#if data.imageUrl??>
					<input type='hidden' name='imageUrl' value="${data.imageUrl!''}"> <img width='200' src="${data.imageUrl!''}">
					<#else>
					<i class="layui-icon"></i>
					<p>点击上传</p>
					</#if>
				</div>
			</div>
		</div>
		<div class="layui-form-item layui-fixed">
			<div class="layui-input-block">
				<button class="layui-btn" type="button" id="submit">立即提交</button>
				<button class="layui-btn layui-btn-primary" id="cancel">取消</button>
			</div>
		</div>
	</form>
</div>
<@footer>
<script>
    //入口
    layui.use(['laydate','upload','form'], function() {
        var $ = layui.jquery;
        var form = layui.form,laydate = layui.laydate,upload = layui.upload;
        var catId = $("#catId").val();
        if (catId !== "") {
            var seletedCatId = $("#one-product-type").find("option:selected").val();
            $("#two-product-type").empty();
            $.get("${ctx}product/getCatList",{type:seletedCatId},function (result) {
                var html = "<option value=''>请选择</option>";
                layui.each(result.data,function (i,j) {
                    if (catId == j.catId) {
                        html+="<option value='"+j.catId+"' selected>"+j.name+"</option>"
                    } else {
                        html+="<option value='"+j.catId+"'>"+j.name+"</option>"
                    }
                })
                $("#two-product-type").append(html);
                form.render();
            })

		}
        //获取一级商品类型
        form.on('select(oneProductType)', function(data){
            var type = $(data.elem).find("option:selected").val() || $("#catId").val();
            $("#catId").val(type);
            getCatList(type,"two-product-type");
        });
        //获取二级商品类型
        form.on('select(twoProductType)', function(data){
            var type = $(data.elem).find("option:selected").val() || $("#catId").val();
            $("#catId").val(type);
        });
        // 获取产品类型
        var getCatList = function (type,id) {
            if (type == "") {
                return;
            }
            $("#"+id).empty();
            $.get("${ctx}product/getCatList",{type:type},function (result) {
                var html = "<option value=''>请选择</option>";
                layui.each(result.data,function (i,j) {
					html+="<option value='"+j.catId+"'>"+j.name+"</option>"
                })
                $("#"+id).append(html);
                form.render();
            })
        }
        upload.render({
            elem: '#img-url'
            ,url: '${ctx}upload'
            ,done: function(res){
                var html = "<input type='hidden' name='imageUrl' value="+res.data[0]+"> <img width='200' src="+res.data[0]+">";
                $("#img-url").html(html)
            }
        });
        $("#submit").on('click', function(){
            var isEdit = false;
            var formEm = $("#form-save").find('form');
            if(!form.onVerify(formEm)){
                return false;
            }
            var pid = $("#pid").val();
            var url = "${ctx}product/add";
            if(pid != "") { //根据pid是否W为空判断是添加还是更新
                url = "${ctx}product/edit"
                isEdit = true;
            }
            $.post(url,formEm.serialize(),function(result){
                if(result.code == 0){
                    formEm[0].reset();	//清空弹框表单内容
                    var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
                    parent.layer.close(index);
                    parent.tools.searchData(isEdit);
                    return;
                }
                layer.msg(result.msg);
            });
		});
        //添加供应商
        $('#add-supplier').on('click', function(){
            layer.open({
                type: 2,
                title: '选择供应商信息',
                shadeClose: true,
                shade: false,
                maxmin: true, //开启最大化最小化按钮
                resize: false,
                area: ['893px', '600px'],
                offset: '0px',
                content: 'supplierIndex'
            });
        });
        $("#cancel").on('click',function () {
            $("#form-save").find('form')[0].reset();
            closeWindow();
        });

        var _tools = {
            //获取选中的供应商信息
            setSupplier: function(supplierId,suppilerName){
                $("#supplier-id").val(supplierId);
                $("#supplier-name").val(suppilerName);
            }
        }
        var closeWindow = function () {
            var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
            parent.layer.close(index);
            parent.tools.searchData();
        }
        window.tools = _tools
    });
</script>
</@footer>
<style type="text/css">
    .layui-elem-field legend {
        margin-left: 20px;
        padding: 0 10px;
        font-size: 12px;
        font-weight: 500;
    }
    .layui-form-item.layui-fixed {
        margin-top: 20px;
        position: fixed;
        right: 20px;
        bottom: 0px;
    }
</style>
