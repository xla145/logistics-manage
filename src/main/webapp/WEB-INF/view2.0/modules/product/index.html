<#include "../../../_layout/_layout2.0.html"><#t>
<@header/>
<div class="admin-main">
	<!-- 按钮组 -->
	<blockquote class="layui-elem-quote">
		<a href="javascript:void(0)" class="layui-btn layui-btn-small operator-btn" data-type="add"><i class="layui-icon">&#xe654;</i> 发布商品</a>
		<!--<a href="#" class="layui-btn layui-btn-small layui-btn-normal operator-btn" data-type="edit"><i class="layui-icon">&#xe642;</i> 编辑</a>-->
		<!--<a href="#" class="layui-btn layui-btn-small layui-btn-danger operator-btn" data-type="delete"><i class="layui-icon">&#xe640;</i> 删除</a>-->
		<a href="#" class="layui-btn layui-btn-small layui-btn-normal operator-btn" data-type="export"><i class="layui-icon">&#xe642;</i> 导出商品</a>
	</blockquote>
	<!-- 筛选组 -->
	<blockquote class="layui-elem-quote filter-bar">
		<form class="layui-form" action="/table.html" id="filterForm">
		     <div class="layui-inline">
		      <label class="layui-filtrate-title">发布时间：</label>
		      <div class="layui-input-inline" style="width: 250px;">
		        <input type="text" name="releaseTime" id="release-time" placeholder="发布时间" class="layui-input">
		      </div>
		    </div>
			<div class="layui-inline">
				<label class="layui-filtrate-title">商品编号：</label>
				<div class="layui-input-inline">
					<input type="text" name="pid" class="layui-input">
				</div>
			</div>
		    <div class="layui-inline">
		      <label class="layui-filtrate-title">商品标题：</label>
		      <div class="layui-input-inline">
		        <input type="text" name="title" class="layui-input">
		      </div>
		    </div>
		    <div class="layui-inline">
		      <label class="layui-filtrate-title">商品状态：</label>
		      <div class="layui-input-inline">
		        <select name="status">
				  <option value=" ">全部</option>
				  <option value="0">初始状态</option>
				  <option value="10">上架</option>
				  <option value="14">售完下架</option>
				  <option value="15">管理员下架</option>
				</select>
		      </div>
		    </div>
			<div class="layui-inline">
				<a href="javascript:void(0)" class="layui-btn layui-btn-small operator-btn" data-type="search"><i class="layui-icon">&#xe615;</i>搜索</a>
				<a href="javascript:void(0)" class="layui-btn layui-btn-small operator-btn" data-type="reset"><i class="layui-icon">&#x1002;</i>重置</a>
			</div>
		</form>
	</blockquote>
	<!-- 表格区域 -->
	<table id="goods-table" lay-filter="goods-table"></table>
	<script type="text/html" id="bar">
		{{# if(d.status === 10){}}
		{{"<a class='layui-btn layui-btn-danger layui-btn-mini' lay-event='downActivity'>下架</a>"}}
		{{# } }}

		{{# if(d.status === 0|| d.status === 14 || d.status === 15){}}
		{{
		"<a class='layui-btn layui-btn-mini layui-btn-mini' lay-event='upActivity'>上架</a>"
		+"<a class='layui-btn layui-btn-mini layui-btn-normal' lay-event='edit'>编辑</a>"
		+"<a class='layui-btn layui-btn-danger layui-btn-mini' lay-event='del'>删除</a>"
		}}
		{{# } }}
		<a class='layui-btn layui-btn-mini' lay-event='info'>详情</a>
	</script>
</div>
<@footer>
<script>
//入口
layui.use(['laydate','layedit','upload','common','table'], function(){
  var $ = layui.jquery;
  var laydate = layui.laydate,
      common = layui.common,
      table = layui.table,
	  form = layui.form;
    //常规用法
  laydate.render({elem: '#release-time',type: 'datetime',range: true});
  //自定义验证
  form.verify({
	price: function(value){
		if(value == "") {
			return '请填写优惠券面额！';
		}
		if(/^[0-9]+(.[0-9]{2})?$/.test(value)){
			return '面额请保留两位小数！';
		}
	}
  });
  //列表渲染
  var tableIns = table.render({
        id: 'goods-table',
        elem: '#goods-table'
        ,url: '${ctx}goods/list'
        ,height: 'full-140'
        ,page: true
        ,method: 'post'
        ,request: {
            pageName: 'pageNo' //页码的参数名称，默认：page
            ,limitName: 'pageSize' //每页数据量的参数名，默认：limit
        }
        ,limits: [15,30,60,90,120]
        ,limit: 15 //默认采用30
        ,size: 'sm'
        ,cols: [[
            {checkbox: true, fixed: true}
            ,{fixed: true,field:'pid', title: '商品编号', width:155}
            ,{field:'title', title: '商品标题', width:200}
            ,{field:'name', title: '商品名称', width:120}
            ,{field:'price', title: '价格', width:80}
            ,{field:'sales', title: '销量', width:80}
            ,{field:'releaseTime', title: '发布日期', width:150,templet: '#timeTpl',sort: true}
            ,{field:'unit', title: '包装单位', width:80}
            ,{field:'supplierName', title: '商品供应商', width:120}
            ,{field:'originalPrice', title: '进货价', width:100}
	        ,{field:'stock', title: '库存', width:80}
          	,{field:'weight', title: '权重', width:80,sort:true}
            ,{fixed: 'right',field:'status', title: '状态', width:100,templet: '#statusTpl'}
            ,{fixed: 'right', width:200, title: '操作', toolbar: '#bar'}
        ]],
    });
    //操作
    var active = {
        search: function () {
            dataReload();
        },
        reset: function () {
            $("#filterForm")[0].reset();
            dataReload();
        },
        add: function(){
            common.layerShowIframe("${ctx}goods/getView","添加商品信息",true);
        },
        edit: function (data) {
            data = data || table.checkStatus('goods-table').data;
            if (data == "" || data.length != 1) {
                layer.msg("请选择一条数据进行编辑！");
                return;
            }
            common.layerShowIframe("${ctx}goods/getView?pid="+data[0].pid,"修改商品信息",true);
        },
        del: function (data) {
            data = data || table.checkStatus('goods-table').data;
            if (data == "") {
                layer.msg("请选择一条数据进行删除！");
                return;
            }
            var ids = new Array();
            layui.each(data, function (i,j) {
                ids.push(j.pid);
            })
            layer.confirm('真的删除该商品吗？', function(index){
                layer.close(index);
                common.post("${ctx}goods/del",{ids: ids},function (result) {
                    if (result.code != 0) {
                        layer.msg(result.msg)
                        return;
                    }
                    dataReload(true);
                })
            });
        },
        upActivity: function (data) {
            layer.confirm("你确定要上架该商品吗？", function(index){
                layer.close(index)
                upOrDownProduct(data[0].pid,data[0].status);
            });
        },
        downActivity: function (data) {
            layer.confirm("你确定要下架该商品吗？", function(index){
                layer.close(index)
                upOrDownProduct(data[0].pid,data[0].status);
            });
        },
        info: function (data) {
            common.layerShowIframe("${ctx}goods/info?pid="+data[0].pid,"商品信息详情",true);
        },
		export: function () {
            var formEm = $("#filterForm").serialize();
            var url = "${ctx}goods/export?"+formEm;
            window.open(url);
        }
    }
  //绑定操作按钮
  $('.operator-btn').on('click', function(){
	var type = $(this).data('type');
	active[type] ? active[type].call(this) : '';
  });
  //监听工具条
  table.on('tool(goods-table)', function(obj){
	var type = obj.event;
	active[type] ? active[type].call(this, [obj.data]) : '';
  });
  //加载数据
  var dataReload = function (isEdit) {
  	if (isEdit) {
	  $(".layui-laypage-btn")[0].click();
	  return;
  	}
	tableIns.reload({
		where: common.formatForm($('#filterForm'))
	});
  }
  //上下架
  var upOrDownProduct = function (pid,status) {
	common.post("${ctx}goods/upOrDownProduct",{ids: pid, status: status},function (result) {
		if (result.code != 0) {
			layer.msg(result.msg);
			return;
		}
		dataReload(true);
	})
  }
  var _tools = {
	searchData: function (isEdit) {
        dataReload(isEdit);
	}
  }
  window.tools = _tools
});
</script>
</@footer>
<script type="text/html" id="statusTpl">
	{{# if(d.status === 0){ }}
	{{ '<span style="color: grey;">初始状态</span>' }}
	{{# } }}
	{{# if(d.status === 10){ }}
	{{ '<span style="color: green;">商品已上架</span>' }}
	{{# } }}
	{{# if((d.status === 14 || d.status === 15)){ }}
	{{ '<span style="color: red;">商品已下架</span>' }}
	{{# } }}
</script>
<script type="text/html" id="timeTpl">
	{{# var fn = function(time){
	var newDate = new Date();
	newDate.setTime(time);
	return newDate.Format("yyyy-MM-dd hh:mm:ss");
	}
	}}
	{{fn(d.releaseTime)}}
</script>