<#include "../../../_layout/_layout2.0.html"><#t>
<@header/>
<div class="admin-main">
	<!-- 按钮组 -->
	<blockquote class="layui-elem-quote">
		<a href="javascript:void(0)" class="layui-btn layui-btn-sm operator-btn" data-type="add"><i class="layui-icon">&#xe654;</i> 添加合作商</a>
	</blockquote>
	<!-- 筛选组 -->
	<blockquote class="layui-elem-quote filter-bar">
		<form class="layui-form" action="/table.html" id="filterForm">
		     <div class="layui-inline">
		      <label class="layui-filtrate-title">合作商名称：</label>
			  <div class="layui-input-inline">
		        <input type="text" name="name" class="layui-input">
		      </div>
		    </div>
		    <div class="layui-inline">
		      <label class="layui-filtrate-title">是否停用：</label>
		      <div class="layui-input-inline">
		        <select name="status">
				  <option value=" ">全部</option>
				  <option value="0">是</option>
				  <option value="10">否</option>
				</select> 
		      </div>
		    </div>
			<div class="layui-inline">
				<a href="javascript:void(0)" class="layui-btn layui-btn-sm operator-btn" data-type="search"><i class="layui-icon">&#xe615;</i>搜索</a>
				<a href="javascript:void(0)" class="layui-btn layui-btn-sm operator-btn" data-type="reset"><i class="layui-icon">&#x1002;</i>重置</a>
			<div>
		</form>
	</blockquote>
	<!-- 表格区域 -->
	<table id="supplier-goods-table" lay-filter="supplier-goods-table"></table>
	<script type="text/html" id="bar">
		{{# if(d.status === 0){}}
		{{
		"<a class='layui-btn layui-btn-xs' lay-event='startOrStop'>启用</a>"+
		"<a class='layui-btn layui-btn-xs layui-btn-normal' lay-event='edit'>编辑</a>"
		}}
		{{# } }}
		{{# if(d.status === 10){}}
		{{"<a class='layui-btn layui-btn-xs layui-btn-danger' lay-event='startOrStop'>停用</a>"}}
		{{# } }}
		<a class='layui-btn layui-btn-xs ' lay-event='info'>详情</a>
	</script>
</div>
<@footer>
<script>
//入口
layui.use(['table','laydate','common','form'], function(){
    var $ = layui.jquery;
    var common = layui.common, table = layui.table ,form = layui.form;
    //列表渲染
    var tableIns = table.render({
        id: 'supplier-goods-table',
        elem: '#supplier-goods-table'
        ,url: '${ctx}supplier/goods/list'
        ,height: 'full-140'
        ,page: true
        ,method: 'post'
        ,request: {
            pageName: 'pageNo' //页码的参数名称，默认：page
            ,limitName: 'pageSize' //每页数据量的参数名，默认：limit
        }
        ,limits: [15,30,60,90,120]
        ,limit: 15 //默认采用30
        ,size: 'sm'
        ,cols: [[
            {checkbox: true, fixed: true}
            ,{fixed: true,field:'name', title: '合作商名称', width:150}
            ,{field:'people', title: '联系人', width:120}
            ,{field:'mobile', title: '电话', width:120}
            ,{field:'fax', title: '传真', width:150}
            ,{field:'url', title: '网址', width:80}
            ,{field:'qq', title: 'QQ', width:80}
            ,{field:'address', title: '地址', minWidth:200}
            ,{field:'createTime', title: '添加时间', width:150,templet: '#createTimeTpl',sort: true}
            ,{field:'stopTime', title: '停用时间', width:150,templet: '#stopTimeTpl',sort: true}
            ,{fixed: 'right',field:'status', title: '状态', width:80,templet: '#statusTpl'}
            ,{fixed: 'right', width:200, title: '操作', toolbar: '#bar'}
        ]],
    });
    //操作
    var active = {
        search: function () {
            dataReload();
        },reset: function () {
            $("#filterForm")[0].reset();
            dataReload();
        },add: function () {
            common.editForm("${ctx}supplier/goods/getView","添加合作商",700,350,function (index, layero) {
                var formEm = $(layero).find('iframe').contents().find("#edit-form");
                if (!form.onVerify(formEm)){
                    return false;
                }
                /**表单提交 **/
                $.post('${ctx}supplier/goods/add', formEm.serialize(), function(result){
                    if(result.code == 0){
                        formEm[0].reset();	//清空弹框表单内容
                        dataReload();
                        layer.close(index);	//关闭弹框
                    }
                    layer.msg(result.msg);
                });
            });
        },edit: function (data) {
            common.editForm("${ctx}supplier/goods/getView?id="+data[0].id,"编辑合作商",700,350,function (index, layero) {
                var formEm = $(layero).find('iframe').contents().find("#edit-form");
                if (!form.onVerify(formEm)){
                    return false;
                }
                /**表单提交 **/
                $.post('${ctx}supplier/goods/edit', formEm.serialize(), function(result){
                    if(result.code == 0){
                        formEm[0].reset();	//清空弹框表单内容
                        dataReload(true);
                        layer.close(index);	//关闭弹框
                    }
                    layer.msg(result.msg);
                });
            });
        },startOrStop: function (data) {
            var msg = "你确定要启用该合作商？";
            if (data[0].status == 10) {
                msg = "你确定要禁用该合作商吗？"
            }
            layer.confirm(msg, function(index){
                layer.close(index)
                startOrStop(data[0].id,data[0].status);
            });
        },info: function (data) {
			common.layerShowIframe("${ctx}supplier/goods/info?id="+data[0].id,"合作商信息",true)
        }
    }
    //绑定操作按钮
    $('.operator-btn').on('click', function(){
        var type = $(this).data('type');
        active[type] ? active[type].call(this) : '';
    });
    //监听工具条
    table.on('tool(supplier-goods-table)', function(obj){
        var type = obj.event;
        active[type] ? active[type].call(this, [obj.data]) : '';
    });
    //加载数据
    var dataReload = function (isEdit) {
        if (isEdit) {
            $(".layui-laypage-btn")[0].click();
            return;
        }
        tableIns.reload({
            where: common.formatForm($('#filterForm'))
        });
    }
    var startOrStop = function (id,status) {
        $.ajax({
            type: "POST",
            url: "${ctx}supplier/goods/changeStatus",
            data: {ids:id,status:status},
            success: function(json) {
                if (json.code == -1){
                    layer.msg(json.msg);
                } else{
                    layer.msg("开启或禁用成功！",{time:500});
                    dataReload();
                }
            }
        });
    }
    window.tools  = {
        searchData: function (isEdit) {
            dataReload(isEdit);
        }
    }
});
</script>
</@footer>
<script type="text/html" id="statusTpl">
	{{# if(d.status === 10){ }}
	{{ '<span style="color: green;">启用</span>' }}
	{{# } }}
	{{# if(d.status === 0){ }}
	{{ '<span style="color: red;">停用</span>' }}
	{{# } }}
</script>
<script type="text/html" id="createTimeTpl">
	{{# var fn = function(time){
	var newDate = new Date();
	newDate.setTime(time);
	return newDate.Format("yyyy-MM-dd hh:mm:ss");
	}
	}}
	{{fn(d.createTime)}}
</script>
<script type="text/html" id="stopTimeTpl">
	{{# var fn = function(time){
	var newDate = new Date();
	newDate.setTime(time);
	return newDate.Format("yyyy-MM-dd hh:mm:ss");
	}
	}}
	{{fn(d.stopTime)}}
</script>