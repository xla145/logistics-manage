<#include "../../_layout/_layout2.0.html"><#t>
<@header/>
<div style="margin: 15px" >
	<form class="layui-form layui-form-pane" id="form-save">
		<div class="layui-form-item">
			<label class="layui-form-label"><span>*</span>单据日期：</label>
			<div class="layui-input-inline">
				<input type="text" name="peDate" class="layui-input" value = "<#if data.peDate??>${data.peDate?string('yyyy-MM-dd HH:mm:ss')}<#else></#if>" id="activity-time">
				<input type="hidden" name="peId" value="${data.peId!''}" id="peId">
			</div>
			<label class="layui-form-label"><span>*</span>采购员：</label>
			<div class="layui-input-inline" style="width: 250px;">
				<input type="text" class="layui-input" name="purchaseName"  value="${data.purchaseName!''}">
			</div>
		</div>
		<blockquote class="layui-elem-quote">
			<a href="javascript:void(0)" class="layui-btn layui-btn-sm operator-btn" data-type="addProduct"><i class="layui-icon">&#xe654;</i> 添加商品</a>
		</blockquote>
		<table id="product-table" lay-filter="product-table"></table>
		<div class="layui-form-item layui-fixed">
			<div class="layui-input-block">
				<button class="layui-btn layui-btn-sm layui-btn-normal operator-btn" type="button" data-type="submit">确定</button>
				<button class="layui-btn layui-btn-sm layui-btn-primary operator-btn" type="button" data-type="reduce">取消</button>
			</div>
		</div>
	</form>
	<div class="product-amount">
		合计：<span class="count">0</span> 总价：<span class="amount">0.00</span>
	</div>
	<script type="text/html" id="product-bar">
		<a class='layui-btn layui-btn-normal layui-btn-xs' lay-event='yes'>确定</a>
		<a class='layui-btn layui-btn-xs' lay-event='update'>修改</a>
		<a class='layui-btn layui-btn-danger layui-btn-xs' lay-event='del'>删除</a>
	</script>
</div>
<@footer>
<script>
	//入口
	layui.use(['laydate','upload','form','table','common'], function() {
		var $ = layui.jquery;
		var form = layui.form,laydate = layui.laydate,table = layui.table,common = layui.common;
        //常规用法
        laydate.render({elem: '#activity-time',type: 'date'});
        form.on('select(vip)', function(data){
            var vipName = $(data.elem).find("option:selected").text();
			$("#vipName").val(vipName);
		});
        form.render();
        //自定义验证规则
        form.verify({
            title: function (value) {
                if(!/^.{3,150}$/.test(value)){
                    return '标题必须3到150位！';
                }
            },
            activityPrice: function(value){
                if(!/^[0-9]+([.]{1}[0-9]+){0,1}$/.test(value)){
                    return '活动价格只能是整数或小数！';
                }
            }
        });
        var data = [];
        $.post("${ctx}purchase/purchaseProductList",{peId:$("#peId").val()},function (result) {
			data = result.data;
            initData(data);
        })
        var tableIns ;
		var initData = function (data) {
            //列表渲染
            tableIns = table.render({
                id: 'product-table',
                elem: '#product-table'
                ,data: data
                ,height: 'full-175'
                ,page: true
                ,method: 'post'
                ,request: {
                    pageName: 'pageNo' //页码的参数名称，默认：page
                    ,limitName: 'pageSize' //每页数据量的参数名，默认：limit
                }
                ,limits: [15,30,60,90,120]
                ,limit: 15 //默认采用30
                ,size: 'sm'
                ,cols: [[
                    {checkbox: true, fixed: true}
                    ,{field:'pid', title: '商品编码', width:150}
                    ,{field:'catName', title: '商品类型', width:100}
                    ,{field:'productPrice', title: '售价', width:80}
                    ,{field:'buyCount', title: '采购数量', width:80,templet: '#buyCount'}
                    ,{field:'wid', title: '仓库', width:120,templet: '#wid'}
                    ,{fixed: 'right', width:150, title: '操作', toolbar: '#product-bar'}
                ]],
            });
        }
        var productCount = 0;
        var productAmount = 0.00;
        //操作
        var active = {
            addProduct: function () {
                common.editForm("${ctx}purchase/productIndex","选择商品",1000,500,function (index, layero) {
                    var productData = $(layero).find('iframe').contents().find("#product-data").val();
                    tableIns.addData(JSON.parse(productData))
                    layer.close(index);
                });
                // tableIns.reload();
       		},
			del: function (obj) {
                layer.confirm('真的删除该商品信息吗？', function(index){
                    obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                    layer.close(index);
                });
            },
            submit: function () {
                var isEdit = false;
                var peId = $("#peId").val();
                var url = "${ctx}purchase/add";
                if(peId != "") { //根据pid是否W为空判断是添加还是更新
                    url = "${ctx}purchase/edit"
                    isEdit = true;
                }
                var formEm = $("#form-save");
                if(!form.onVerify(formEm)){
                    return false;
                }
                $.post(url,formEm.serialize()+"&productData="+JSON.stringify(tableIns.getTableData()),function(result){
                    if(result.code == 0){
                        formEm[0].reset();	//清空弹框表单内容
                        var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
                        parent.layer.close(index);
                        parent._tools.searchData(isEdit);
                        return;
                    }
                    layer.msg(result.msg);
                });
            },
			reduce:function () {
                $("#form-save")[0].reset();
                closeWindow(true);
            },

			yes:function (obj) {
                let price = obj.data.productPrice;
                if (parseInt(productCount) >= parseInt(obj.data.buyCount)) {
                    productCount -= parseInt(obj.data.buyCount);
                    productAmount -= parseFloat(obj.data.buyCount*price);
				}
                var tr = obj.tr;
                var wid = tr.find("#warehouse").val();
                var productNumber = tr.find(".product-number").val() || obj.data.buyCount || 0;
                obj.update({
                    buyCount: productNumber,
					wid: wid
				});
                productCount += parseInt(productNumber);
                productAmount += parseFloat(price*productNumber);
                tr.find(".product-number").parent().text(productNumber);
                tr.find(".product-number").attr("type","hidden");
                $(".count").html(parseInt(productCount));
                $(".amount").html(parseFloat(productAmount));
//                $(".edit-col").css("display","none");
            },
            update:function (obj) {
                var tr = obj.tr;
                var $this = tr.find('td').eq(4);
                var productNumber = ""
                if (obj.data.buyCount !== null) {
                    productNumber = obj.data.buyCount;
				}
                $this.find('.layui-table-cell').text("")
                var html = '<input type= "number" name="buyCount" class="layui-input product-number"/>';
                $this.find('.layui-table-cell').append(html);
                $this.find('.layui-table-cell .product-number').val(productNumber);
                $(".edit-col").css("display","");
            }
		}
        var closeWindow = function (isEdit) {
            var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
            parent.layer.close(index);
            parent.tools.searchData(isEdit);
        }
        //绑定操作按钮
        $('.operator-btn').on('click', function(){
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
        //监听工具条
        table.on('tool(product-table)', function(obj){
            var type = obj.event;
            active[type] ? active[type].call(this, obj) : '';
        });
	});
	function changeWid(wid,dom) {
        $(dom).parent().find("#warehouse").val(wid);
        $(dom).parent().parent().append($(dom).find("option:selected").text());
    }
</script>
<script type="text/html" id="buyCount">
	<div class="edit-col">
		<input type="number" name="buyCount" class="layui-input product-number"  value="{{# if(d.buyCount !== null){ }}{{d.buyCount}}{{# }; }}" />
	</div>
</script>
<script type="text/html" id="wid">
	<div class="edit-col">
		<input type="hidden" id="warehouse">
		<select name="wid" lay-ignore class="wid" onchange="changeWid(this.value,this)">
			<@module name="option" class="com.logistics.label.impl.GetWarehouseNode"  checked="{{d.wid}}"/>
		</select>
	</div>
</script>
</@footer>
<style type="text/css">
    .layui-form-item.layui-fixed {
        margin-top: 20px;
        position: fixed;
        right: 20px;
        bottom: 10px;
    }
	.product-number,.wid {
		height: 20px;
	}
</style>
